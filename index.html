<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Push‑to‑Talk (Full Feature)</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#f6f7fb;color:#111}
header{padding:12px 16px;background:#111;color:#fff;display:flex;justify-content:space-between;align-items:center}
main{padding:12px}
.primary{background:#2b6cff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
.accent{background:#10b981;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
.danger{background:#ef4444;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
.badge{background:#eee;border-radius:999px;padding:4px 10px;margin-left:8px}
#joinPanel,#appPanel{max-width:1200px;margin:0 auto}
#joinForm{display:grid;grid-template-columns:1fr;gap:10px;max-width:420px}
#appPanel{display:grid;grid-template-columns:320px 1fr;gap:12px;margin-top:16px}
.sidebar{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px;height:75vh;overflow:auto}
.sidebar ul{list-style:none;margin:6px 0;padding:0}
.sidebar li{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
.sidebar li .dot{width:10px;height:10px;border-radius:50%}
.sidebar li img{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid #ddd}
.sidebar li .name{font-weight:600}
.chat{display:flex;flex-direction:column;gap:8px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.log{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px;height:46vh;overflow:auto}
.composer{display:flex;gap:8px}
.composer input{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px}
.typing{font-size:.9em;color:#555}
.video-area{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start}
video{max-width:240px;border-radius:8px;border:1px solid #ddd;background:#000}
select, input[type=text]{padding:8px;border:1px solid #ccc;border-radius:8px}
button:disabled{opacity:.5;cursor:not-allowed}
#errorOverlay{position:fixed;inset:0;background:rgba(220,38,38,.92);color:#fff;padding:16px;font-family:monospace;display:none;z-index:9999;overflow:auto}
#errorOverlay h2{margin-top:0}
</style>
</head>
<body>
<header>
  <h1>Push‑to‑Talk</h1>
  <div>
    <label for="camMode">Camera:</label>
    <select id="camMode" aria-label="Camera mode">
      <option value="front" selected>Front</option>
      <option value="rear">Rear</option>
      <option value="dual">Dual (front + rear)</option>
    </select>
  </div>
</header>

<div id="errorOverlay"><h2>Script error</h2><pre id="errText"></pre></div>

<main>
  <section id="joinPanel">
    <form id="joinForm" autocomplete="off">
      <label for="nickname">Nickname</label>
      <input id="nickname" type="text" required/>
      <label for="statusSel">Status</label>
      <select id="statusSel">
        <option value="Online" selected>Online</option>
        <option value="DND">Do Not Disturb</option>
      </select>
      <label for="avatar">Profile picture (optional)</label>
      <input id="avatar" type="file" accept="image/*"/>
      <button type="submit" class="primary">Join Lobby</button>
    </form>
  </section>

  <section id="appPanel" hidden>
    <aside class="sidebar">
      <h3>Users</h3>
      <ul id="userList" aria-live="polite"></ul>
      <h3>Rooms</h3>
      <ul id="roomList" aria-live="polite"></ul>
      <button id="createRoomBtn" class="primary">➕ Create Room</button>
      <button id="backToLobbyBtn" class="primary" style="margin-top:6px;">⬅ Back to Lobby</button>
      <hr/>
      <button id="startEmergencyBtn" class="danger">🚨 Start Emergency Track</button>
      <button id="stopEmergencyBtn" class="primary" disabled>🛑 Stop Emergency</button>
    </aside>

    <section class="chat">
      <div class="toolbar">
        <button id="pttBtn" class="accent">🎤 Hold to Talk</button>
        <button id="voiceNoteBtn">🎙 Voice Note</button>
        <button id="fileBtn">📎 File</button>
        <button id="locationBtn">📍 Share Location</button>
        <button id="videoBtn">📹 Start Video</button>
        <span id="scopeBadge" class="badge">Lobby</span>
      </div>

      <div class="video-area">
        <video id="localVideo" autoplay muted playsinline></video>
      </div>

      <div id="log" role="log" aria-live="polite" tabindex="0" class="log"></div>

      <div class="composer">
        <input id="msgInput" type="text" placeholder="Message…"/>
        <button id="sendBtn" class="primary">Send</button>
      </div>
      <div id="typing" aria-live="polite" class="typing" hidden></div>
    </section>
  </section>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
window.addEventListener('error', (e)=>{
  const ov=document.getElementById('errorOverlay');
  document.getElementById('errText').textContent=(e.error&&e.error.stack)?e.error.stack:(e.message||'Unknown error');
  ov.style.display='block';
});
window.addEventListener('unhandledrejection',(e)=>{
  const ov=document.getElementById('errorOverlay');
  document.getElementById('errText').textContent = e.reason && e.reason.stack ? e.reason.stack : (e.reason || 'Promise rejection');
  ov.style.display='block';
});

function isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent); }
function isAndroid(){ return /Android/.test(navigator.userAgent); }
function addLog(text){ const d=document.createElement('div'); d.textContent=text; document.getElementById('log').appendChild(d); document.getElementById('log').scrollTop=document.getElementById('log').scrollHeight; }
function saveBlob(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000); }
function openNativeMaps(lat, lon, label='Location'){
  const enc=encodeURIComponent(label);
  if(isIOS()){ const url=`maps://?q=${enc}&ll=${lat},${lon}`; const t=setTimeout(()=>window.open(`http://maps.apple.com/?q=${enc}&ll=${lat},${lon}`,'_blank'),300); window.location.href=url; setTimeout(()=>clearTimeout(t),1000); return; }
  if(isAndroid()){ window.location.href=`geo:${lat},${lon}?q=${lat},${lon}(${enc})`; return; }
  window.open(`https://www.google.com/maps?q=${lat},${lon}(${enc})`,'_blank');
}
function openNativeNavigation(lat, lon, label='Destination'){
  const enc=encodeURIComponent(label);
  if(isIOS()){ const url=`maps://?daddr=${lat},${lon}&q=${enc}`; const t=setTimeout(()=>window.open(`http://maps.apple.com/?daddr=${lat},${lon}&q=${enc}`,'_blank'),300); window.location.href=url; setTimeout(()=>clearTimeout(t),1000); return; }
  if(isAndroid()){ try{ window.location.href=`google.navigation:q=${lat},${lon}`; }catch{ window.location.href=`geo:0,0?q=${lat},${lon}(${enc})`; } return; }
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`,'_blank');
}

const socket = io({ path:'/socket.io', transports:['websocket','polling'], reconnection:true, reconnectionAttempts:Infinity, reconnectionDelay:800, reconnectionDelayMax:3000 });
let me={ id:null, name:null, status:'Online', avatar:null };
let scope={ type:'lobby', roomId:null, name:null };
let mediaRecorder=null, chunks=[];
const localVideo=document.getElementById('localVideo');
const camModeSel=document.getElementById('camMode');

(function initStoredName(){ const n=localStorage.getItem('ptt_name'); if(n) document.getElementById('nickname').value=n; })();

socket.on('connect', ()=> addLog('Connected '+socket.id));
socket.on('joined', ({me:info})=>{
  me=info; localStorage.setItem('ptt_name', me.name);
  document.getElementById('joinPanel').hidden=true; document.getElementById('appPanel').hidden=false;
  addLog('Joined as '+me.name);
  const m=location.pathname.match(/\/room\/(.+)$/); if(m&&m[1]) socket.emit('switch-room',{roomId:m[1]});
});
socket.on('update-user-list', users=>{
  const ul=document.getElementById('userList'); ul.innerHTML='';
  users.forEach(u=>{ const li=document.createElement('li'); li.dataset.id=u.id; li.textContent=`${u.name} — ${u.status}`; ul.append(li); });
});
socket.on('room-list', rooms=>{
  const ul=document.getElementById('roomList'); ul.innerHTML='';
  rooms.forEach(r=>{ const li=document.createElement('li'); li.textContent=`${r.name} (${r.members.length})${r.pinned?' 📌':''}`; li.onclick=()=>socket.emit('switch-room',{roomId:r.id}); ul.append(li); });
});
socket.on('scope', s=>{
  scope=s; document.getElementById('scopeBadge').textContent=s.type==='lobby'?'Lobby':`Room: ${s.name}`;
  if(s.url && location.pathname!==s.url) history.replaceState({}, s.name, s.url);
  addLog('Switched to '+document.getElementById('scopeBadge').textContent);
});
socket.on('message', ({from,text})=> addLog(from+': '+text));
socket.on('typing', ({name})=>{ const t=document.getElementById('typing'); t.hidden=false; t.textContent=name+' is typing…'; setTimeout(()=>t.hidden=true,1200); });
socket.on('voice', async ({from,data,mime})=>{ addLog(from+' sent a voice clip'); const blob=new Blob([new Uint8Array(data)],{type:mime||'audio/webm'}); const a=document.createElement('audio'); a.controls=true; a.src=URL.createObjectURL(blob); const btn=document.createElement('button'); btn.textContent='Save'; btn.onclick=()=>saveBlob('voice_'+Date.now()+'.webm',blob); const row=document.createElement('div'); row.append(a,btn); document.getElementById('log').append(row); });
socket.on('file', ({from,name,data})=>{ addLog(from+' sent file '+name); const blob=new Blob([new Uint8Array(data)]); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.textContent='Download'; document.getElementById('log').append(a); });
socket.on('location', ({from,lat,lon})=>{ const div=document.createElement('div'); div.textContent=`${from} shared a location`; const open=document.createElement('button'); open.textContent='Open in Maps'; open.onclick=()=>openNativeMaps(lat,lon,from+' location'); const nav=document.createElement('button'); nav.textContent='Navigate'; nav.onclick=()=>openNativeNavigation(lat,lon,from+' location'); div.append(' ',open,' ',nav); document.getElementById('log').append(div); });
socket.on('emergency-signal', ({from,action,meta})=>{ if(action==='start') addLog('🚨 Emergency from '+from.name); if(action==='gps'&&meta){ const div=document.createElement('div'); div.textContent='GPS update from '+from.name; const open=document.createElement('button'); open.textContent='Open in Maps'; open.onclick=()=>openNativeMaps(meta.lat,meta.lon,from.name+' emergency'); const nav=document.createElement('button'); nav.textContent='Navigate'; nav.onclick=()=>openNativeNavigation(meta.lat,meta.lon,from.name+' emergency'); div.append(' ',open,' ',nav); document.getElementById('log').append(div);} if(action==='stop') addLog('🛑 Emergency ended'); });

document.getElementById('joinForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const name=document.getElementById('nickname').value.trim(); if(!name) return;
  const status=document.getElementById('statusSel').value;
  let avatar=null; const av=document.getElementById('avatar'); if(av.files[0]){ avatar=await av.files[0].arrayBuffer().then(buf=>'data:image/*;base64,'+btoa(String.fromCharCode(...new Uint8Array(buf)))); }
  socket.emit('join',{name,status,avatar});
});

document.getElementById('sendBtn').addEventListener('click', ()=>{
  const text=document.getElementById('msgInput').value.trim(); if(!text) return;
  socket.emit('message',{ scope: scope.type, roomId: scope.roomId, text }); document.getElementById('msgInput').value='';
});
document.getElementById('msgInput').addEventListener('keydown', e=>{ socket.emit('typing',{ scope: scope.type, roomId: scope.roomId, typing:true }); if(e.key==='Enter'){ e.preventDefault(); document.getElementById('sendBtn').click(); } });

document.getElementById('fileBtn').addEventListener('click', ()=>{
  const i=document.createElement('input'); i.type='file';
  i.onchange=async()=>{ const f=i.files[0]; if(!f) return; const buf=await f.arrayBuffer(); socket.emit('file',{ scope: scope.type, roomId: scope.roomId, name:f.name, data:Array.from(new Uint8Array(buf)) }); };
  i.click();
});

document.getElementById('locationBtn').addEventListener('click', ()=>{
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude:lat, longitude:lon}=pos.coords;
    socket.emit('location',{ scope: scope.type, roomId: scope.roomId, lat, lon });
  }, err=> addLog('Location error: '+err.message));
});

// PTT / Voice
const pttBtn=document.getElementById('pttBtn');
pttBtn.addEventListener('mousedown', startRec); pttBtn.addEventListener('touchstart', startRec);
pttBtn.addEventListener('mouseup', stopRec); pttBtn.addEventListener('touchend', stopRec);
document.getElementById('voiceNoteBtn').addEventListener('click', async()=>{ const s=await navigator.mediaDevices.getUserMedia({audio:true}); chunks=[]; mediaRecorder=new MediaRecorder(s); mediaRecorder.ondataavailable=e=>chunks.push(e.data); mediaRecorder.onstop=async()=>{ const b=new Blob(chunks,{type: mediaRecorder.mimeType||'audio/webm'}); const arr=Array.from(new Uint8Array(await b.arrayBuffer())); socket.emit('voice',{ scope: scope.type, roomId: scope.roomId, data: arr, mime:b.type }); }; mediaRecorder.start(); setTimeout(()=>mediaRecorder.stop(),1500); });
async function startRec(){ const s=await navigator.mediaDevices.getUserMedia({audio:true}); chunks=[]; mediaRecorder=new MediaRecorder(s); mediaRecorder.ondataavailable=e=>chunks.push(e.data); mediaRecorder.onstop=async()=>{ const b=new Blob(chunks,{type: mediaRecorder.mimeType||'audio/webm'}); const arr=Array.from(new Uint8Array(await b.arrayBuffer())); socket.emit('voice',{ scope: scope.type, roomId: scope.roomId, data: arr, mime:b.type }); }; mediaRecorder.start(); }
function stopRec(){ if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); }

// Rooms
document.getElementById('createRoomBtn').addEventListener('click', ()=>{
  const ids=[...document.querySelectorAll('#userList li[data-id]')].map(li=>li.getAttribute('data-id')).filter(id=>id!==socket.id);
  socket.emit('create-room',{ name:'Room '+Math.random().toString(36).slice(2,6), memberIds: ids, pinned:true });
});
document.getElementById('backToLobbyBtn').addEventListener('click', ()=>{
  if(scope.type==='lobby') return;
  history.replaceState({}, 'Lobby', '/'); socket.emit('switch-room',{ roomId: null });
  scope = { type:'lobby', roomId:null, name:null }; document.getElementById('scopeBadge').textContent='Lobby'; addLog('Returned to Lobby');
});

// Video (preview only)
const currentMedia={}; function stopTracks(s){ if(!s) return; s.getTracks().forEach(t=>t.stop()); }
async function startVideo(mode){ stopTracks(currentMedia.stream); let facing=mode==='rear'?{exact:'environment'}:'user'; let stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing,width:640,height:480},audio:true}); currentMedia.stream=stream; localVideo.srcObject=stream; }
document.getElementById('videoBtn').addEventListener('click', ()=> startVideo(camModeSel.value));
camModeSel.addEventListener('change', ()=>{ if(localVideo.srcObject) startVideo(camModeSel.value); });
</script>
</body>
</html>
