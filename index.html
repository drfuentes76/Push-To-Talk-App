<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pushâ€‘toâ€‘Talk (Merged Hotfix)</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#f6f7fb;color:#111}
header{padding:12px 16px;background:#111;color:#fff;display:flex;justify-content:space-between;align-items:center}
main{padding:12px}
.primary{background:#2b6cff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
.accent{background:#10b981;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
.danger{background:#ef4444;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
.badge{background:#eee;border-radius:999px;padding:4px 10px;margin-left:8px}
#joinPanel,#appPanel{max-width:1200px;margin:0 auto}
#joinForm{display:grid;grid-template-columns:1fr;gap:10px;max-width:420px}
#appPanel{display:grid;grid-template-columns:320px 1fr;gap:12px;margin-top:16px}
.sidebar{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px;height:75vh;overflow:auto}
.sidebar ul{list-style:none;margin:6px 0;padding:0}
.sidebar li{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
.sidebar li .dot{width:10px;height:10px;border-radius:50%}
.sidebar li img{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid #ddd}
.sidebar li .name{font-weight:600}
.chat{display:flex;flex-direction:column;gap:8px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.log{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px;height:46vh;overflow:auto}
.composer{display:flex;gap:8px}
.composer input{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px}
.typing{font-size:.9em;color:#555}
.video-area{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start}
video{max-width:240px;border-radius:8px;border:1px solid #ddd;background:#000}
select, input[type=text]{padding:8px;border:1px solid #ccc;border-radius:8px}
button:disabled{opacity:.5;cursor:not-allowed}
#errorOverlay{position:fixed;inset:0;background:rgba(220,38,38,.92);color:#fff;padding:16px;font-family:monospace;display:none;z-index:9999;overflow:auto}
#errorOverlay h2{margin-top:0}
</style>
</head>
<body>
<header>
  <h1>Pushâ€‘toâ€‘Talk</h1>
  <div>
    <label for="camMode">Camera:</label>
    <select id="camMode" aria-label="Camera mode">
      <option value="front" selected>Front</option>
      <option value="rear">Rear</option>
      <option value="dual">Dual (front + rear)</option>
    </select>
  </div>
</header>

<div id="errorOverlay"><h2>Script error</h2><pre id="errText"></pre></div>

<main>
  <section id="joinPanel">
    <form id="joinForm" autocomplete="off">
      <label for="nickname">Nickname</label>
      <input id="nickname" type="text" required/>
      <label for="statusSel">Status</label>
      <select id="statusSel">
        <option value="Online" selected>Online</option>
        <option value="DND">Do Not Disturb</option>
      </select>
      <label for="avatar">Profile picture (optional)</label>
      <input id="avatar" type="file" accept="image/*"/>
      <button type="submit" class="primary">Join Lobby</button>
    </form>
  </section>

  <section id="appPanel" hidden>
    <aside class="sidebar">
      <h3>Users</h3>
      <ul id="userList" aria-live="polite"></ul>
      <h3>Rooms</h3>
      <ul id="roomList" aria-live="polite"></ul>
      <button id="createRoomBtn" class="primary">â• Create Room</button>
      <button id="backToLobbyBtn" class="primary" style="margin-top:6px;">â¬… Back to Lobby</button>
      <hr/>
      <button id="startEmergencyBtn" class="danger">ğŸš¨ Start Emergency Track</button>
      <button id="stopEmergencyBtn" class="primary" disabled>ğŸ›‘ Stop Emergency</button>
    </aside>

    <section class="chat">
      <div class="toolbar">
        <button id="pttBtn" class="accent">ğŸ¤ Hold to Talk</button>
        <button id="voiceNoteBtn">ğŸ™ Voice Note</button>
        <button id="fileBtn">ğŸ“ File</button>
        <button id="locationBtn">ğŸ“ Share Location</button>
        <button id="videoBtn">ğŸ“¹ Start Video Conference</button>
        <span id="scopeBadge" class="badge">Lobby</span>
      </div>

      <div class="video-area">
        <video id="localVideo" autoplay muted playsinline></video>
      </div>

      <div id="log" role="log" aria-live="polite" tabindex="0" class="log"></div>

      <div class="composer">
        <input id="msgInput" type="text" placeholder="Messageâ€¦"/>
        <button id="sendBtn" class="primary">Send</button>
      </div>
      <div id="typing" aria-live="polite" class="typing" hidden></div>
    </section>
  </section>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
window.addEventListener('error', (e)=>{
  const ov=document.getElementById('errorOverlay');
  document.getElementById('errText').textContent=(e.error&&e.error.stack)?e.error.stack:(e.message||'Unknown error');
  ov.style.display='block';
});
window.addEventListener('unhandledrejection',(e)=>{
  const ov=document.getElementById('errorOverlay');
  document.getElementById('errText').textContent = e.reason && e.reason.stack ? e.reason.stack : (e.reason || 'Promise rejection');
  ov.style.display='block';
});

function isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent); }
function isAndroid(){ return /Android/.test(navigator.userAgent); }
function openNativeMaps(lat, lon, label='Location'){
  const enc = encodeURIComponent(label);
  if(isIOS()){
    const url = `maps://?q=${enc}&ll=${lat},${lon}`;
    const t=setTimeout(()=>window.open(`http://maps.apple.com/?q=${enc}&ll=${lat},${lon}`,'_blank'),300);
    window.location.href=url; setTimeout(()=>clearTimeout(t),1000); return;
  }
  if(isAndroid()){
    window.location.href = `geo:${lat},${lon}?q=${lat},${lon}(${enc})`; return;
  }
  window.open(`https://www.google.com/maps?q=${lat},${lon}(${enc})`,'_blank');
}
function openNativeNavigation(lat, lon, label='Destination'){
  const enc=encodeURIComponent(label);
  if(isIOS()){
    const url=`maps://?daddr=${lat},${lon}&q=${enc}`;
    const t=setTimeout(()=>window.open(`http://maps.apple.com/?daddr=${lat},${lon}&q=${enc}`,'_blank'),300);
    window.location.href=url; setTimeout(()=>clearTimeout(t),1000); return;
  }
  if(isAndroid()){
    try{ window.location.href=`google.navigation:q=${lat},${lon}`; }catch{ window.location.href=`geo:0,0?q=${lat},${lon}(${enc})`; } return;
  }
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`,'_blank');
}
function saveBlob(name, blob){
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
}
function addLog(text){
  const d=document.createElement('div'); d.className='entry'; d.textContent=text;
  document.getElementById('log').appendChild(d);
  document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
}

const socket = io({ path:'/socket.io', transports:['websocket','polling'], reconnection:true, reconnectionAttempts:Infinity, reconnectionDelay:800, reconnectionDelayMax:3000 });
let me = { id:null, name:null, status:'Online', avatar:null };
let scope = { type:'lobby', roomId:null, name:null };

(function initStoredName(){
  const stored = localStorage.getItem('ptt_name');
  if(stored){ document.getElementById('nickname').value = stored; }
})();

socket.on('connect', ()=>{ me.id = socket.id; addLog('Connected: '+socket.id); });
socket.on('reconnect', ()=>{ addLog('Reconnected'); });

socket.on('joined', ({me:info})=>{
  Object.assign(me, info);
  localStorage.setItem('ptt_name', me.name);
  document.getElementById('joinPanel').hidden=true;
  document.getElementById('appPanel').hidden=false;
  addLog(`Joined as ${me.name}`);
  const m = location.pathname.match(/\/room\/(.+)$/);
  if(m && m[1]){ socket.emit('switch-room', { roomId: m[1] }); }
});

socket.on('update-user-list', (users)=>{
  const ul=document.getElementById('userList'); ul.innerHTML='';
  users.forEach(u=>{
    const li=document.createElement('li'); li.dataset.id=u.id;
    li.textContent = `${u.name} â€” ${u.status}`;
    ul.append(li);
  });
});

socket.on('room-list', (rooms)=>{
  const ul=document.getElementById('roomList'); ul.innerHTML='';
  rooms.forEach(r=>{
    const li=document.createElement('li');
    li.textContent=`${r.name} (${r.members.length})${r.pinned?' ğŸ“Œ':''}`;
    li.tabIndex=0; li.addEventListener('click', ()=> socket.emit('switch-room',{ roomId:r.id }));
    ul.append(li);
  });
});

socket.on('scope', (s)=>{
  scope = s;
  document.getElementById('scopeBadge').textContent = s.type==='lobby' ? 'Lobby' : `Room: ${s.name}`;
  if(s.url && location.pathname !== s.url){ history.replaceState({}, s.name, s.url); }
  addLog(`Switched to ${document.getElementById('scopeBadge').textContent}`);
});

document.getElementById('joinForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('nickname').value.trim(); if(!name) return;
  const status = 'Online';
  socket.emit('join', { name, status, avatar: null });
});

document.getElementById('createRoomBtn').addEventListener('click', ()=>{
  const ids=[...document.querySelectorAll('#userList li[data-id]')].map(li=>li.getAttribute('data-id')).filter(id=>id!==socket.id);
  socket.emit('create-room',{ name:'Room '+Math.random().toString(36).slice(2,6), memberIds: ids, pinned:true });
});

document.getElementById('backToLobbyBtn').addEventListener('click', ()=>{
  if(scope.type==='lobby') return;
  history.replaceState({}, 'Lobby', '/');
  socket.emit('switch-room',{ roomId: null });
  scope = { type:'lobby', roomId:null, name:null };
  document.getElementById('scopeBadge').textContent='Lobby';
  addLog('Returned to Lobby');
});

// Messaging (minimal for merged hotfix)
document.getElementById('sendBtn').addEventListener('click', ()=>{
  const text=document.getElementById('msgInput').value.trim(); if(!text) return;
  socket.emit('message',{ scope: scope.type, roomId: scope.roomId, text });
  document.getElementById('msgInput').value='';
});
socket.on('message', ({from, text})=> addLog(from+': '+text));
</script>
</body>
</html>
